/* =========================================================
   QMS â€“ FULL SINGLE FILE BUILD (PLAIN HTML VERSION)
   ========================================================= */

/* =========================
   GLOBAL STATE
   ========================= */
const state = {
  evaluations: [],
  templates: JSON.parse(localStorage.getItem("qms_templates")) || [],
  notificationSettings:
    JSON.parse(localStorage.getItem("qms_notification_settings")) || {
      teamLeadEmail: "",
      notifyAgents: false,
    },
  autoFailed: false,
  pendingCalibration: [],
  disputeEvalId: null,
  agents: [],
};

/* =========================
   GLOBAL ERROR GUARD
   ========================= */
window.addEventListener("error", (e) => {
  console.error("[GLOBAL ERROR]", e?.error || e?.message || e);
  alert("JS error: " + (e?.error?.message || e?.message || "check console"));
});

/* =========================
   SUPABASE CONFIG
   ========================= */
const SUPABASE_URL = "https://ceebnevkectnlvjapidg.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlZWJuZXZrZWN0bmx2amFwaWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNDk4NTcsImV4cCI6MjA4MDkyNTg1N30.8Z-12vrB3J_Rc3Jht-YeaG2NFTiFHBisqH3Yll-_cts";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   EMAILJS INIT
   ========================= */
function initEmailJS() {
  if (!window.emailjs) {
    console.error("[EmailJS] library not loaded");
    return false;
  }
  try {
    emailjs.init("-6lNUhMst6-9ZiCof");
    console.log("[EmailJS] initialized");
    return true;
  } catch (e) {
    console.error("[EmailJS] init failed:", e);
    return false;
  }
}

/* =========================
   HELPERS
   ========================= */
function escapeHtml(s) {
  if (s == null) return "";
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function uuid() {
  if (window.crypto?.randomUUID) return window.crypto.randomUUID();
  const b = new Uint8Array(16);
  (window.crypto || window.msCrypto).getRandomValues(b);
  b[6] = (b[6] & 0x0f) | 0x40;
  b[8] = (b[8] & 0x3f) | 0x80;
  const hex = [...b].map((x) => x.toString(16).padStart(2, "0")).join("");
  return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(
    12,
    16
  )}-${hex.slice(16, 20)}-${hex.slice(20)}`;
}

function getChannelName(channel) {
  const map = { call: "Phone Call", chat: "Live Chat", email: "Email" };
  return map[channel] || channel;
}
  /* =========================================================
   SCORING + VALIDATION LOGIC
   ========================================================= */

function recomputeAutoFail() {
  let failing = false;

  document.querySelectorAll(".item.critical").forEach((item) => {
    const noSel = !!item.querySelector(".btn.no.selected");
    if (noSel) failing = true;
  });

  state.autoFailed = failing;

  const msg = document.getElementById("autofail-message");
  if (msg) {
    msg.style.display = state.autoFailed ? "block" : "none";
  }
}

function computeMaxTotal() {
  let max = 0;
  document.querySelectorAll(".item").forEach((item) => {
    const w =
      parseInt(
        item.querySelector(".btn.yes")?.getAttribute("data-weight")
      ) || 0;

    const isNASelected = !!item.querySelector(".btn.na.selected");

    if (!isNASelected) {
      max += w;
    }
  });

  return max;
}

function unansweredCount() {
  const total = document.querySelectorAll(".item").length;
  let count = 0;

  document.querySelectorAll(".item").forEach((i) => {
    if (i.querySelector(".btn.selected")) count++;
  });

  return total - count;
}

function totalNoCount() {
  return document.querySelectorAll(".btn.no.selected").length;
}

function validateNoComments() {
  let missing = 0;

  document.querySelectorAll(".item").forEach((item) => {
    const isNo = !!item.querySelector(".btn.no.selected");
    const ta = item.querySelector(".comments");
    const cwrap = item.querySelector(".cwrap");

    if (isNo) {
      if (cwrap) cwrap.classList.add("show");

      if (ta) {
        if (!ta.value.trim()) {
          missing++;
          ta.classList.add("required");
          item.classList.add("error");
        } else {
          ta.classList.remove("required");
          item.classList.remove("error");
        }
      }
    } else {
      if (ta) ta.classList.remove("required");
      item.classList.remove("error");
    }
  });

  return missing;
}

function updateSubmitState() {
  const missing = validateNoComments();
  const unanswered = unansweredCount();
  const noCount = totalNoCount();

  const chip1 = document.getElementById("chip-unanswered");
  const chip2 = document.getElementById("chip-missing-comments");
  const chip3 = document.getElementById("chip-no-count");
  const submitBtn = document.getElementById("submit-evaluation");

  if (chip1) chip1.textContent = "Unanswered: " + unanswered;
  if (chip2) chip2.textContent = '"No" w/o comment: ' + missing;
  if (chip3) chip3.textContent = 'Total "No": ' + noCount;

  if (submitBtn) submitBtn.disabled = unanswered > 0 || missing > 0;
}

function updateCurrentScore() {
  const maxTotal = computeMaxTotal();
  const maxEl = document.getElementById("max-score");
  if (maxEl) maxEl.textContent = String(maxTotal || 100);

  if (state.autoFailed) {
    const current = document.getElementById("current-score");
    const pf = document.getElementById("pass-fail-indicator");

    if (current) current.textContent = "0";

    if (pf) {
      pf.textContent = "FAIL";
      pf.className = "pf fail";
    }

    updateSubmitState();
    return;
  }

  let totalScore = 0;

  document.querySelectorAll(".item").forEach((item) => {
    const yesBtn = item.querySelector(".btn.yes");
    const w = parseInt(yesBtn?.getAttribute("data-weight")) || 0;

    const isNA = !!item.querySelector(".btn.na.selected");
    const isYes = !!item.querySelector(".btn.yes.selected");

    if (!isNA && isYes) {
      totalScore += w;
    }
  });

  const current = document.getElementById("current-score");
  if (current) current.textContent = totalScore;

  const pf = document.getElementById("pass-fail-indicator");
  if (pf) {
    if (totalScore >= 80) {
      pf.textContent = "PASS";
      pf.className = "pf pass";
    } else {
      pf.textContent = "FAIL";
      pf.className = "pf fail";
    }
  }

  updateSubmitState();
}

function onChoice(btn) {
  const item = btn.closest(".item");

  item
    .querySelectorAll(".btn.yes,.btn.no,.btn.na")
    .forEach((b) => b.classList.remove("selected"));

  btn.classList.add("selected");

  const cwrap = item.querySelector(".cwrap");
  if (cwrap) cwrap.classList.add("show");

  if (!btn.classList.contains("no")) {
    const ta = item.querySelector(".comments");
    if (ta) ta.classList.remove("required");
    item.classList.remove("error");
  }

  recomputeAutoFail();
  updateCurrentScore();
}

/* =========================================================
   EVENT DELEGATION
   ========================================================= */

document.addEventListener("click", (e) => {
  const t = e.target;

  if (t.matches(".btn.yes, .btn.no, .btn.na")) {
    onChoice(t);
    return;
  }

  if (t.matches(".tab")) {
    document.querySelectorAll(".tab").forEach((x) =>
      x.classList.remove("active")
    );

    t.classList.add("active");

    const tn = t.getAttribute("data-tab");

    document
      .querySelectorAll(".tab-content")
      .forEach((c) => (c.style.display = "none"));

    const tabEl = document.getElementById(tn + "-tab");
    if (tabEl) tabEl.style.display = "block";

    return;
  }
});
      /* =========================================================
   EVALUATION SUBMISSION
   ========================================================= */

async function createEvaluation(evaluationUi) {
  try {
    const { data, error } = await sb
      .from("evaluations")
      .insert([evaluationUi])
      .select()
      .single();

    if (error) throw error;

    state.evaluations.unshift(data);
    displayEvaluations();
    updateDashboard();
  } catch (err) {
    console.error("[evaluations] create error (local fallback):", err);

    // fallback to local only
    state.evaluations.unshift({
      ...evaluationUi,
      created_at: new Date().toISOString(),
    });

    displayEvaluations();
    updateDashboard();
    alert("Server save failed; saved locally for now.");
  }
}

document
  .getElementById("evaluation-form")
  ?.addEventListener("submit", async function (e) {
    e.preventDefault();

    const unanswered = unansweredCount();
    const missing = validateNoComments();

    if (unanswered > 0 || missing > 0) {
      alert("Please resolve all unanswered items and required comments.");
      return;
    }

    const selectedAgentId =
      document.getElementById("agent-select")?.value || "";

    const agent = state.agents.find(
      (a) => String(a.id) === String(selectedAgentId)
    );

    const agentName = agent ? agent.name : "";

    const ticketNumber =
      document.getElementById("ticket-number")?.value.trim() || "";

    const channel =
      document.getElementById("channel")?.value || "";

    const date =
      document.getElementById("date")?.value || "";

    const overallComments =
      document.getElementById("overall-comments")?.value || "";

    const criteriaScores = [];

    document.querySelectorAll(".item").forEach((item) => {
      const qText =
        item.querySelector(".q")?.childNodes[0]?.textContent?.trim() || "";

      const yes = !!item.querySelector(".btn.yes.selected");
      const na = !!item.querySelector(".btn.na.selected");

      const yesBtn = item.querySelector(".btn.yes");
      const w = parseInt(yesBtn?.getAttribute("data-weight")) || 0;

      const comments = item.querySelector(".comments")?.value || "";
      const isCritical = item.classList.contains("critical");
      const sectionName = item.getAttribute("data-section");

      criteriaScores.push({
        name: qText,
        weight: w,
        passed: yes,
        isNA: na,
        isCritical,
        comments,
        section: sectionName,
      });
    });

    let total = 0;

    if (!state.autoFailed) {
      criteriaScores.forEach((c) => {
        if (!c.isNA && c.passed) total += c.weight;
      });
    }

    const evaluation = {
      id: uuid(),
      agent_id: selectedAgentId,
      agent_name: agentName,
      ticket_number: ticketNumber,
      channel,
      date,
      criteria_scores: criteriaScores,
      overall_score: state.autoFailed ? 0 : total,
      auto_failed: state.autoFailed,
      passed: !state.autoFailed && total >= 80,
      overall_comments: overallComments,
      created_at: new Date().toISOString(),
      dispute: null,
      calibration: null,
    };

    await createEvaluation(evaluation);

    // RESET FORM
    this.reset();

    document
      .querySelectorAll(".btn.yes,.btn.no,.btn.na")
      .forEach((b) => b.classList.remove("selected"));

    document
      .querySelectorAll(".cwrap")
      .forEach((w) => w.classList.remove("show"));

    document
      .querySelectorAll(".comments")
      .forEach((t) => {
        t.classList.remove("required");
        t.value = "";
      });

    document
      .querySelectorAll(".item")
      .forEach((i) => i.classList.remove("error"));

    state.autoFailed = false;

    updateCurrentScore();

    alert("Evaluation submitted successfully!");
  });

/* =========================================================
   LIST DISPLAY
   ========================================================= */

function displayEvaluations() {
  const list = document.getElementById("evaluations-list");
  const empty = document.getElementById("no-evaluations");

  if (!list) return;

  list.innerHTML = "";

  if (!state.evaluations.length) {
    if (empty) empty.style.display = "block";
    return;
  }

  if (empty) empty.style.display = "none";

  state.evaluations
    .slice()
    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
    .forEach((ev) => {
      const card = document.createElement("div");
      card.className = "card";

      const badge = ev.passed
        ? '<span class="pf pass">PASS</span>'
        : '<span class="pf fail">FAIL</span>';

      card.innerHTML = `
        <div class="card-b">
          <h4 style="margin:0 0 6px 0">
            ${escapeHtml(ev.agent_name)} 
            - ${new Date(ev.date).toLocaleDateString()}
          </h4>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
            ${badge}
            <span class="badge">Score: ${ev.overall_score}/100</span>
            <span class="badge">Channel: ${escapeHtml(
              getChannelName(ev.channel)
            )}</span>
          </div>
        </div>
      `;

      list.appendChild(card);
    });
}
/* =========================================================
   DASHBOARD
   ========================================================= */

function updateDashboard() {
  const total = state.evaluations.length;

  const kpi = document.getElementById("kpi-evals");
  if (kpi) kpi.textContent = total;

  const passedCount = state.evaluations.filter((e) => e.passed).length;
  const passRate = total ? (passedCount / total) * 100 : 0;

  const passRateEl = document.getElementById("pass-rate");
  if (passRateEl) passRateEl.textContent = passRate.toFixed(1) + "%";

  const avg =
    total > 0
      ? state.evaluations.reduce(
          (sum, e) => sum + (Number(e.overall_score) || 0),
          0
        ) / total
      : 0;

  const avgEl = document.getElementById("avg-score");
  if (avgEl) avgEl.textContent = avg.toFixed(1) + "%";
}

/* =========================================================
   AGENTS (SUPABASE)
   ========================================================= */

async function fetchAgents() {
  try {
    const { data, error } = await sb
      .from("agents")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) throw error;

    state.agents = data || [];
    displayAgents();
    updateAgentDropdown();
  } catch (err) {
    console.error("[agents] fetch error:", err);
  }
}

async function createAgent({ name, email, team, position }) {
  try {
    const { data, error } = await sb
      .from("agents")
      .insert([{ name, email, team, position }])
      .select()
      .single();

    if (error) throw error;

    state.agents.unshift(data);
    displayAgents();
    updateAgentDropdown();
  } catch (err) {
    console.error("[agents] create error:", err);
  }
}

async function removeAgent(id) {
  try {
    const { error } = await sb.from("agents").delete().eq("id", id);
    if (error) throw error;

    state.agents = state.agents.filter((a) => a.id !== id);
    displayAgents();
    updateAgentDropdown();
  } catch (err) {
    console.error("[agents] delete error:", err);
  }
}

function displayAgents() {
  const list = document.getElementById("agents-list");
  const empty = document.getElementById("no-agents");

  if (!list) return;

  list.innerHTML = "";

  if (!state.agents.length) {
    if (empty) empty.style.display = "block";
    return;
  }

  if (empty) empty.style.display = "none";

  state.agents.forEach((a) => {
    const item = document.createElement("div");
    item.className = "card";

    item.innerHTML = `
      <div class="card-b" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">${escapeHtml(a.name)}</div>
          <div class="hint">${escapeHtml(a.position)} - ${escapeHtml(
      a.team
    )}</div>
          <div class="hint">${escapeHtml(a.email)}</div>
        </div>
        <button class="ghost delete-agent" data-id="${a.id}">Delete</button>
      </div>
    `;

    item
      .querySelector(".delete-agent")
      .addEventListener("click", () => removeAgent(a.id));

    list.appendChild(item);
  });
}

function updateAgentDropdown() {
  const sel = document.getElementById("agent-select");
  if (!sel) return;

  sel.innerHTML = '<option value="">Select an Agent</option>';

  state.agents.forEach((a) => {
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.name;
    sel.appendChild(opt);
  });
}

/* =========================================================
   EMAIL NOTIFICATIONS
   ========================================================= */

function loadNotificationSettings() {
  const emailInput = document.getElementById("team-lead-email");
  const notifyCheckbox = document.getElementById("notify-agents");

  if (emailInput)
    emailInput.value = state.notificationSettings.teamLeadEmail || "";

  if (notifyCheckbox)
    notifyCheckbox.checked =
      !!state.notificationSettings.notifyAgents;
}

async function sendEmail(to, templateId, evaluation, htmlBody) {
  if (!window.emailjs) throw new Error("EmailJS not loaded");

  return emailjs.send("service_iirmd95", templateId, {
    to_email: to,
    agent_name: evaluation.agent_name,
    message: htmlBody,
  });
}

/* =========================================================
   INIT
   ========================================================= */

document.addEventListener("DOMContentLoaded", () => {
  initEmailJS();
  fetchAgents();
  updateDashboard();
  loadNotificationSettings();
  updateCurrentScore();

  const dashboardTab = document.querySelector(
    '.tab[data-tab="dashboard"]'
  );

  if (dashboardTab) dashboardTab.click();
});
      
